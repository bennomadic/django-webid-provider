{% extends "django_webid/provider/base.html" %}

{% load i18n %}
{% load uni_form_tags %}


{% block head_title %}{% blocktrans %}WebID: Client Certificate{% endblocktrans %}{% endblock %}

{% block extra_head %}
<script type="text/javascript" src="{{ MEDIA_URL }}django_webid/provider/js/jquery-1.7.min.js"></script>
<script type="text/javascript" src="{{ MEDIA_URL }}django_webid/provider/js/jquery-ui-1.8.17.custom.min.js"></script>
<script type="text/javascript" src="{{ MEDIA_URL }}django_webid/provider/js/jquery.browser.min.js"></script>
<link rel="stylesheet" href="{{ MEDIA_URL }}django_webid/provider/js/css/ui-lightness/jquery-ui-1.8.17.custom.css" type="text/css" media="all" />
<!--[if IE]>
  <script type="text/javascript" src="{{ MEDIA_URL }}django_webid/provider/js/explorer-keygen.js"></script>
<![endif]-->
{% endblock %}

{% block body %}

{% if messages %}
    <ul id="messages">
        {% for message in messages %}
        <li id="message_{{ forloop.counter }}">{{message}}</li>
        {% endfor %}
    </ul>
{% endif %}

<style>
#dialog {
	display:hidden !important;
}

</style>

<script type="text/javascript">

	(function($) {
	    $(document).ready(function($) {
		    	{% comment %}
			var HIDE_KEYGEN_FORM should be passed from view (certconfig opt)
			XXX should try with iframe also, this is a bit
			buggy when page loads slowly.
			{% endcomment %}
			$('#dialog').hide();
			{% if HIDE_KEYGEN_FORM %}
			$('#webid-block').hide();
			$('#autowebidinstall').click( function(event) {
				event.preventDefault();
				$('#webid-keygen').click();
				});
			{% endif %}
//XXX DETECT CHROME and trigger dialog
{% comment %}
Workaround for Chromium Issue #52949: Keygen should occur asynchronously and display UI feedback
http://code.google.com/p/chromium/issues/detail?can=2&q=52949&colspec=ID%20Pri%20Mstone%20ReleaseBlock%20Area%20Feature%20Status%20Owner%20Summary&id=52949
... and we disable button after 1st click.
//XXX TODO: disable also the hover effect.
ugh... the UI is frozen, so the img does not "move"... ugliness everywhere...
{% endcomment %}
			$("#webid-keygen").click( function(e) {
				console.debug('keygen button pressed');
				if($(this).hasClass('sent')){
					e.preventDefault();
					return false;
				}
				if($(this).hasClass('prevented')){
					console.debug('prevented');
					e.preventDefault();
					{% comment %}
					//XXX show only if Chromium.

					{% endcomment %}
					if($.browser.name === "chrome") {
						$("#dialog").dialog();
						//XXX modal breaks interaction?
						//$("#dialog").dialog({modal:true});
					}
					$(this).removeClass('prevented');
					setTimeout(function() {
						$("#webid-keygen").click();
						console.debug('clicking on submit again');
						}, 10); 
				}else{
					console.debug('triggering and preventing...');
					$(this).addClass('prevented');
					$(this).addClass('sent');
				}
			});
	    });
	})($);
</script>
<div id="dialog" title="Key Generation in Progress...">
<p>{% trans "This may take some minutes. Please wait..." %}</p>
<img src="{{ MEDIA_URL }}django_webid/provider/img/ajax-loader.gif"/>
</div>


<div class="middle_panel" id="webid-block">

    <h1>{% trans "Installing a WebID Certificate in your Browser" %}</h1>
    <p>After clicking the "Give me a cert!" button, a certificate will be created and installed in your browser. This certificate will point to <a href="{% url webidprovider-webid_uri username=user %}"</a>your WebID URI</a> on this site, and you'll be able to use it to login in any WebID-enabled site.</p>
    <p>How should this cert installation step look like? (help links with screenshots)</p>

    {#% include "django_webid/provider/webid_intro.html" %#}
    
    <div class="form-toggle">
        <form class="uniForm" method="POST" action="">
	    {% csrf_token %}
            <fieldset class="inlineLabels">
                <div class="form_block">
                    <input type="hidden" name="action" value="keygen" />
		    <keygen name="pubkey" challenge="{{ challenge }}" id="webid-keygentag">
                    <input type="submit" class="prevented" value="{% trans "Give me a cert!" %}" name="keygen" id="webid-keygen"/>
                </div>
            </fieldset>
        </form>
    </div>

</div>

{% if HIDE_KEYGEN_FORM %}
<div>
	<h2>Automatic WebID installation</h2>
	<input type="submit" value="{% trans "Install my WebID in this browser" %}" id="autowebidinstall"/>
</div>
{% endif %}
{# XXX move image to css #}
<img src="{{MEDIA_URL}}django_webid/provider/images/idlewheel.gif"/>
{% endblock %}

{% block extra_body %}
{% endblock %}

